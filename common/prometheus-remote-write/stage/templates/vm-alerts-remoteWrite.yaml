---
{{ if not .Values.vm_alert_skip }}
{{- $alertMetrics := (list
"flant_backups_restic_hours_passed_since_last_backup"
"flant_backups_restic_health"
"deckhouse_release_channel"
"d8_release_info"
"deckhouse_live_ticks"
"deckhouse_tasks_queue_length"
"deckhouse_config_values_errors_total"
"container_cpu_usage_seconds_total"
"container_memory_usage_bytes"
"container_memory_working_set_bytes:without_kmem"
"kube_pod_info"
"kube_node_info"
"kube_node_labels"
"node_uname_info"
"node_cpu_seconds_total"
"kube_pod_status_ready"
"node_nf_conntrack_entries"
"node_nf_conntrack_entries_limit"
"kube_node_spec_unschedulable"
"node_memory_SUnreclaim_bytes"
"node_memory_MemTotal_bytes"
"node_memory_MemAvailable_bytes"
"d8_deprecated_legacy_annotation"
"resource_versions_compatibility"
"up"
"network_connections_quota_utilization"
"d8_node_group_node_with_deprecated_availability_zone"
"kube_pod_labels"
"kube_pod_status_phase"
"kube_service_labels"
"istio_build"
"d8_istio_.*"
"controller_runtime_reconcile_errors_total"
"cloud_data_discovery_cloud_request_error"
"node_group_node_status"
"kube_node_status_allocatable"
"kube_pod_container_status_running"
"kube_pod_container_resource_requests"
"kube_pod_container_resource_limits"
"nginx_ingress_controller_config_last_reload_successful"
"kube_pod_container_status_restarts_total"
"kruise_daemonset_.*"
"cloud_data_.*"
"d8_gatekeeper_exporter_constraint_violations"
"apiserver_client_certificate_expiration_seconds_count"
"apiserver_client_certificate_expiration_seconds_bucket"
"kubelet_volume_stats_available_bytes"
"kubelet_volume_stats_capacity_bytes"
"kube_persistentvolume_status_phase"
"kube_node_status_condition"
"kubelet_certificate_manager_client_ttl_seconds"
"kubelet_certificate_manager_server_ttl_seconds"
"billing:namespace:labels:product_id"
"node_vmstat_oom_kill"
"node_pressure_memory_stalled_seconds_total"
"node_pressure_memory_waiting_seconds_total"
"node_pressure_cpu_waiting_seconds_total"
"node_pressure_io_stalled_seconds_total"
"node_pressure_io_waiting_seconds_total"
"argocd_app_info"
"kube_service_status_load_balancer_ingress"
"kube_node_role"
"kube_controller_pod"
"d8_etcd_quota_backend_total"
"etcd_mvcc_db_total_size_in_bytes"
"mcm_machine_deployment_status_unavailable_replicas"
"machine_deployment_node_group_info"
"mcm_machine_deployment_status_ready_replicas"
"d8_nodegroup_taint_missing"
"coredns_panics_total"
"certmanager_certificate_expiration_timestamp_seconds"
"etcd_server_has_leader"
"etcd_server_leader_changes_seen_total"
"node_filesystem_readonly"
"vector_component_errors_total"
"vector_events_discarded_total"
"node_ntp_offset_seconds:abs"
"node_timex_sync_status") | join "|"
}}
apiVersion: deckhouse.io/v1
kind: PrometheusRemoteWrite
metadata:
  name: vminsert-devops-lmru-tech-vm-alert-remote-write
spec:
  url: http://vmalertsinsert-stage.devops.lmru.tech:8480/insert/0/prometheus
  writeRelabelConfigs:
    - sourceLabels: [__name__]
      action: keep
      regex: {{ $alertMetrics }}
    - sourceLabels: [__name__, namespace]
      regex: "(kube_pod_container_resource_requests|kube_pod_container_resource_limits|container_memory_usage_bytes|container_cpu_usage_seconds_total|container_memory_working_set_bytes:without_kmem);d8-ingress-nginx"
      targetLabel: "keep"
      replacement: "yes"
    - sourceLabels: [__name__, keep]
      regex: "(kube_pod_container_resource_requests|kube_pod_container_resource_limits|container_memory_usage_bytes|container_cpu_usage_seconds_total|container_memory_working_set_bytes:without_kmem);"
      action: drop
{{end}}
